import axios from "axios"
import { useEffect, useState } from "react";

export default function Info(props){
    const [response, setResponse] = useState(false)

    let date = new Date(props.lastModified)
    date = date.toLocaleDateString("en-GB");

    useEffect(() => {
        if (props.hash !== undefined && response === false && JSON.parse(props.hash).hashSHA256){
            const options = {
                method: 'GET',
                url: `https://www.virustotal.com/api/v3/files/${JSON.parse(props.hash).hashSHA256}`,
                headers: {
                  accept: 'application/json',
                  "x-apikey": props.API_KEY
              }
              };
            
            axios
              .request(options)
              .then((res) => {
                console.log(res.data);
                setResponse(res.status);
              })
              .catch(function (error) {
                console.log(response, error.message, error.response.status);
                if (error.response.status === 404){
                    
                    const url = "http://localhost:3001/add-malware"
                    const config = {
                        headers: {
                            'content-type': 'application/json',
                        },
                    };

                    const jsonData = {
                        name: props.name,
                        size: props.size,
                        type: props.type,
                        hashSHA256: JSON.parse(props.hash).hashSHA256
                    }
                    console.log("adding malware")
                    axios.post(url, jsonData, config)
                        .then((res) => {
                            console.log(res.data);
                        });
                }
                setResponse(error.status)
              });
        }
    }, [props, response])
    

    return (
        <div className="info">
            <p>File Information:</p>
            <p>Name: {props.name}</p>
            <p>Size: {props.size} bytes</p>
            <p>Type: {props.type}</p>
            <p>Last Modified: {date}</p>
            {(response === false)?<p>Searching database...</p>:
            (response === 200)?<p>Hash found in database!</p>:<p>Hash NOT found in database!</p>}
            
        </div>
    )
}