import axios from "axios"
import { useState } from "react";

export default function Info(props){
    const [response, setResponse] = useState(false)
    // const [API_KEY, setAPI_Key] = useState(null)

    // async function getAPIKey(){
    //     const response = await axios.get(`http://localhost:3001/APIKey`);
    //     setAPI_Key(response.data.API_KEY);
    //     // console.log({API_KEY})
    // }

    // if (!API_KEY) getAPIKey()

    let date = new Date(props.lastModified)
    date = date.toLocaleDateString("en-GB");

    // console.log(JSON.parse(props.hash).hashSHA256);

    if (props.hash !== undefined && JSON.parse(props.hash).hashSHA256){
        const options = {
            method: 'GET',
            url: `https://www.virustotal.com/api/v3/files/${JSON.parse(props.hash).hashSHA256}`,
            headers: {
              accept: 'application/json',
              "x-apikey": props.API_KEY
          }
          };

        axios
          .request(options)
          .then(function (response) {
            console.log(response.data);
            setResponse(response.status);
          })
          .catch(function (error) {
            console.log(error.message, error.response.status);
            if (error.response.status === 404){
                
                const url = "http://localhost:3001/add-malware"
                const config = {
                    headers: {
                        'content-type': 'application/json',
                    },
                };

                // const formData = new FormData();
                // formData.append('name', props.name);
                // formData.append('size', props.size);
                // formData.append('type', props.type);
                // formData.append('hash', JSON.parse(props.hash).hashSHA256);
                const jsonData = {
                    name: props.name,
                    size: props.size,
                    type: props.type,
                    hashSHA256: JSON.parse(props.hash).hashSHA256
                }
                console.log("adding malware")
                axios.post(url, jsonData, config)
                    .then((response) => {
                        console.log(response.data);
                    });
            }
            setResponse(error.status)
          });
    }

    return (
        <div className="info">
            <p>File Information:</p>
            <p>Name: {props.name}</p>
            <p>Size: {props.size} bytes</p>
            <p>Type: {props.type}</p>
            <p>Last Modified: {date}</p>
            {(response === false)?<p>Searching database...</p>:
            (response === 200)?<p>Hash found in database!</p>:<p>Hash NOT found in database!</p>}
            
        </div>
    )
}